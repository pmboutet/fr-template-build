minimum_cumulusci_version: '3.62.0'
project:
    name: fr-template-build
    package:
        name: France Template
        api_version: '55.0'
    dependencies:
        - github: https://github.com/SalesforceFoundation/NPSP
        - github: https://github.com/pmboutet/findock-fr-template-build

    git:
        default_branch: 'main'
        repo_url: https://github.com/pmboutet/fr-template-build

    source_format: sfdx

sources:
    npsp:
        github: https://github.com/SalesforceFoundation/NPSP
    findock:
        github: https://github.com/pmboutet/findock-fr-template-build
plans:
  install:
    slug: install
    title: Install French Template
    tier: primary
    description: Install French Template
    is_listed: True
    checks:
      - when: "not tasks.check_my_domain_active()"
        action: error
        message: "Please enable My Domain in your org prior to installing."    
      - when: "'npsp' not in tasks.get_installed_packages()"
        action: error
        message: "France Template requires the Nonprofit Success Pack. Please install the Nonprofit Success Pack and try again."
    steps:
        1:
            task: sffr_list_views
            ui_options:
                name: Configure FR Contact List Views
        2:
            flow: sffr_profile
            ui_options:
                name: Update System Administrator Profile
        3:
            task: disable_tdtm_trigger_handlers
            ui_options:
                name: Disable NPSP TDTM Triggers (Required if loading sample data)
                is_required: False
                is_recommended: True
            options:
              namespace: npsp
              active: False
        4:
            task: sffr_load_sdata
            ui_options:
                name: Load Sample data for Organizations, Households, Donations, and Addresses
                is_required: False
                is_recommended: True
        5:
            task: restore_tdtm_trigger_handlers
            ui_options:
                name: Restore NPSP TDTM Triggers status (Required if TDTM were disabled)
                is_required: False
                is_recommended: True
            options:
              namespace: npsp
              restore: True
        6: 
            task: sffr_assign_compact_layout
            ui_options: 
                name: Assign Compact Layout to Contact

tasks:
    robot:
        options:
            suites: robot/fr-template-build/tests
            options:
                outputdir: robot/fr-template-build/results
 
    robot_testdoc:
        options:
            path: robot/fr-template-build/tests
            output: robot/fr-template-build/doc/fr-template-build_tests.html
 
    run_tests:
        options:
            required_org_code_coverage_percent: 75

    sffr_list_views:
        description: Configure Contact List Views
        class_path: cumulusci.tasks.salesforce.Deploy
        group: "SFFR: Installation"
        options:
            path: unpackaged/listviews

    sffr_load_sdata:
        description: Load Sample Dataset for Organizations, Households, and Addresses
        class_path: cumulusci.tasks.bulkdata.LoadData
        group: "NPSP: Post Installation"
        options:
            mapping: datasets/mapping.yml
            sql_path: datasets/sample.sql
            drop_missing_schema: True

    sffr_translations:
        description: Configure Translations
        class_path: cumulusci.tasks.salesforce.Deploy
        group: "SFFR: Translations"
        options:
            path: unpackaged/translations
    
    sffr_assign_compact_layout:
         class_path: cumulusci.tasks.metadata_etl.UpdateMetadataFirstChildTextTask
         options:
            metadata_type: CustomObject
            managed: False
            namespace_inject: $project_config.project__package__namespace
            entity: CustomObject
            api_names: Contact
            tag: compactLayoutAssignment
            value: "%%%NAMESPACE%%%SFFR_Contact_Compact_Layout"   

flows:
    dependencies:
        steps:
            3:
                flow: npsp:config_managed

    config_dev:
        steps:
            3:
                flow: findock:configure_findock
            4:
                flow: complete_install
                
    config_qa:
        steps:
            3:
                flow: findock:configure_findock
            4:
                flow: complete_install

    complete_install:
        description: France Template Installation Configuration and Sample Data
        steps:
          1:
            flow: config_only
          2:
            task: disable_tdtm_trigger_handlers
            options:
              handlers:
                        - CRLP_Rollup_TDTM
                        - RLLP_OppRollup_TDTM
                        - RD2_RecurringDonationsOpp_TDTM
              namespace: npsp
              active: false
              restore: false
          3:
            task: sffr_load_sdata
          4:
            task: restore_tdtm_trigger_handlers
            options:
              handlers:
                        - CRLP_Rollup_TDTM
                        - RLLP_OppRollup_TDTM
                        - RD2_RecurringDonationsOpp_TDTM
              namespace: npsp
              active: true
              restore: true

    config_only:
        description: France Template Installation Configuration Only
        steps:
          1:
            task: sffr_assign_compact_layout
          2: 
            task: sffr_list_views
          3:
            flow: sffr_profile
          4:
            task: sffr_translations

    sffr_profile:
        steps:
          1:
            task: update_admin_profile
            ui_options:
                name: Update Admin profile object and field access permissions
                is_required: True
                is_recommended: True
            options:
              record_types:
                - record_type: Campaign.SFFR_External_Segment
                - record_type: Campaign.SFFR_Internal_Segment
                - record_type: Campaign.SFFR_Campaign
                  default: true

          2:
            task: deploy
            ui_options:
                name: Update Admin profile applications assignment
                is_required: True
                is_recommended: True
            
            options:
              path: unpackaged/profile