minimum_cumulusci_version: '3.62.0'
project:
    name: fr-template-build
    package:
        name: France Template
        api_version: '55.0'
    dependencies:
        - github: 'https://github.com/SalesforceFoundation/NPSP'
    git:
        default_branch: 'main'
    source_format: sfdx

sources:
    npsp:
        github: https://github.com/SalesforceFoundation/NPSP
    postinstall:
        github: 'https://github.com/SFDO-Alliances/NPSP-PostInstallSteps'
 
plans:
  install:
    slug: install
    title: Install France Template
    tier: primary
    description: Install France Template steps
    is_listed: True
    checks:
      - when: "not tasks.check_my_domain_active()"
        action: error
        message: "Please enable My Domain in your org prior to installing."    
      - when: "'npsp' not in tasks.get_installed_packages()"
        action: error
        message: "France Template requires the Nonprofit Success Pack. Please install the Nonprofit Success Pack and try again."
    steps:
        1:
            task: sffr_apps
            ui_options:
                name: Add Fundraising French Template Apps
        2:
            task: sffr_flexipages
            ui_options:
                name: Add Fundraising French Template Flexipages
        3:
            task: sffr_list_views
            ui_options:
                name: Configure Contact List Views
        4:
            flow: sffr_profile
            ui_options:
                name: Update System Administrator Profile
        5:
            task: disable_tdtm_trigger_handlers
            ui_options:
                name: Disable NPSP TDTM Triggers (Required if loading sample data)
                is_required: False
                is_recommended: True
            options:
              namespace: npsp
              active: False
        6:
            task: sffr_load_sdata
            ui_options:
                name: Load Sample data for Organizations, Households, Donations, and Addresses
                is_required: False
                is_recommended: True
        7:
            task: restore_tdtm_trigger_handlers
            ui_options:
                name: Restore NPSP TDTM Triggers status (Required if TDTM were disabled)
                is_required: False
                is_recommended: True
            options:
              namespace: npsp
              restore: True

tasks:
    robot:
        options:
            suites: robot/fr-template-build/tests
            options:
                outputdir: robot/fr-template-build/results
 
    robot_testdoc:
        options:
            path: robot/fr-template-build/tests
            output: robot/fr-template-build/doc/fr-template-build_tests.html
 
    run_tests:
        options:
            required_org_code_coverage_percent: 75
    
    sffr_apps:
        description: Add Fundraising French Template Apps
        class_path: cumulusci.tasks.salesforce.Deploy
        group: "SFFR: Installation"
        options:
            path: force-app/main/default/applications

    sffr_flexipages:
        description: Add Fundraising French Template Flexipages
        class_path: cumulusci.tasks.salesforce.Deploy
        group: "SFFR: Installation"
        options:
            path: force-app/main/default/flexipages

    sffr_list_views:
        description: Configure Contact List Views
        class_path: cumulusci.tasks.salesforce.Deploy
        group: "SFFR: Installation"
        options:
            path: unpackaged/pre/listviews

    sffr_load_sdata:
        description: Load Sample Dataset for Organizations, Households, and Addresses
        class_path: cumulusci.tasks.bulkdata.LoadData
        group: "NPSP: Post Installation"
        options:
            mapping: datasets/mapping.yml
            sql_path: datasets/sample.sql
            drop_missing_schema: True
 
flows:
    dependencies:
        steps:
            3:
                flow: npsp:config_managed
            4:
                flow: npsp:enable_rd2_managed
 
    config_dev:
        steps:
            3:
                flow: postinstall:config_only
            4:
                flow: complete_install

    complete_install:
        description: France Template Installation Configuration and Sample Data
        steps:
          1:
            task: sffr_apps
          2:
            task: sffr_flexipages     
          3:
            flow: sffr_profile
          4:
            task: disable_tdtm_trigger_handlers
            options:
              namespace: npsp
              active: False
          5:
            task: sffr_load_sdata
          6:
            task: restore_tdtm_trigger_handlers
            options:
              namespace: npsp
              restore: True

    sffr_profile:
        steps:
          1:
            task: update_admin_profile
            ui_options:
                name: Update Admin profile object and field access permissions
                is_required: True
                is_recommended: True
            fields:
                - field: Contact.SFFR_Campaign_Origin__c
                - field: Contact.SFFR_Do_Not_Thanks__c
                - field: Contact.SFFR_GDPR_Status__c
                - field: Contact.SFFR_No_Tax_Receipt__c    
                - field: Contact.SFFR_Retrict_Yearly_Marketing_Sol__c
                - field: npsp__Address__c.SFFR_UM__c         
                - field: npsp__Address__c.SFFR_UM_Reason__c  

          2:
            task: deploy
            ui_options:
                name: Update Admin profile record type and layout assignments
                is_required: True
                is_recommended: True
            
            options:
              path: force-app/main/default/profiles